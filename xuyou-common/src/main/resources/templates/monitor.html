<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="30">
    <title>è®¸æŸš - æ•°æ®åº“ç›‘æ§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .status-healthy {
            color: #28a745;
        }

        .status-warning {
            color: #ffc107;
        }

        .status-critical {
            color: #dc3545;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .btn-reset {
            background: #e53e3e;
        }

        .btn-reset:hover {
            background: #c53030;
        }

        .issues-list {
            margin-top: 10px;
        }

        .issue-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #fee;
            border-left: 3px solid #e53e3e;
        }

        .warning-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
        }

        .refresh-info {
            color: #666;
            font-size: 0.9em;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>è®¸æŸš - æ•°æ®åº“ç›‘æ§</h1>
        <p>Druid è¿æ¥æ± å®æ—¶ç›‘æ§é¢æ¿</p>
    </div>

    <div class="card">
        <h2>è¿æ¥æ± çŠ¶æ€</h2>
        <div id="poolStatus" class="stats-grid">
            <!-- åŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <div class="card">
        <h2>å¥åº·æ£€æŸ¥</h2>
        <div id="healthStatus">
            <!-- åŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <div class="card">
        <h2>æ“ä½œ</h2>
        <button class="btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        <button class="btn btn-reset" onclick="resetStats()">ğŸ”„ é‡ç½®ç»Ÿè®¡</button>
        <button class="btn" onclick="checkCapabilities()">ğŸ” æ£€æŸ¥åŠŸèƒ½</button>
    </div>

    <div id="capabilities" class="card" style="display: none;">
        <h2>ç›‘æ§åŠŸèƒ½</h2>
        <div id="capabilitiesContent">
            <!-- åŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <div class="refresh-info">
        æœ€åæ›´æ–°: <span id="lastUpdate">å°šæœªæ›´æ–°</span>
    </div>
</div>

<script>
    let refreshInterval;

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
        refreshData();
        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
        refreshInterval = setInterval(refreshData, 30000);
    });

    // åˆ·æ–°æ•°æ®
    async function refreshData() {
        try {
            // è·å–æ‘˜è¦ä¿¡æ¯
            const summaryResponse = await fetch('/api/monitor/druid/summary');
            const summary = await summaryResponse.json();

            // è·å–å¥åº·çŠ¶æ€
            const healthResponse = await fetch('/api/monitor/druid/health');
            const health = await healthResponse.json();

            updatePoolStatus(summary);
            updateHealthStatus(health);

            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
        } catch (error) {
            console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
            showError('æ— æ³•è¿æ¥åˆ°ç›‘æ§æœåŠ¡');
        }
    }

    // æ›´æ–°è¿æ¥æ± çŠ¶æ€
    function updatePoolStatus(data) {
        const poolStatusDiv = document.getElementById('poolStatus');

        if (data.error) {
            poolStatusDiv.innerHTML = `<div class="stat-item"><div class="stat-value status-critical">é”™è¯¯</div><div class="stat-label">${data.error}</div></div>`;
            return;
        }

        let html = '';

        // è¿æ¥æ± çŠ¶æ€
        if (data.poolStatus) {
            html += `
                    <div class="stat-item">
                        <div class="stat-value">${data.poolStatus.active}/${data.poolStatus.max}</div>
                        <div class="stat-label">æ´»åŠ¨è¿æ¥</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.poolStatus.idle}</div>
                        <div class="stat-label">ç©ºé—²è¿æ¥</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.poolStatus.waitThreads || 'N/A'}</div>
                        <div class="stat-label">ç­‰å¾…çº¿ç¨‹</div>
                    </div>
                `;
        }

        // ä½¿ç”¨ç‡
        if (data.usage) {
            const statusClass = data.usage.status === 'CRITICAL' ? 'status-critical' :
                data.usage.status === 'WARNING' ? 'status-warning' : 'status-healthy';

            html += `
                    <div class="stat-item">
                        <div class="stat-value ${statusClass}">${data.usage.usageRate}</div>
                        <div class="stat-label">ä½¿ç”¨ç‡ (${data.usage.status})</div>
                    </div>
                `;
        }

        poolStatusDiv.innerHTML = html;
    }

    // æ›´æ–°å¥åº·çŠ¶æ€
    function updateHealthStatus(data) {
        const healthDiv = document.getElementById('healthStatus');

        let html = '';

        if (data.error) {
            html = `<div class="issue-item">é”™è¯¯: ${data.error}</div>`;
            healthDiv.innerHTML = html;
            return;
        }

        // çŠ¶æ€æŒ‡ç¤ºå™¨
        const statusClass = data.status === 'UNHEALTHY' ? 'status-critical' :
            data.status === 'WARNING' ? 'status-warning' : 'status-healthy';

        html += `<div class="stat-item">
                        <div class="stat-value ${statusClass}">${data.status}</div>
                        <div class="stat-label">å¥åº·çŠ¶æ€</div>
                    </div>`;

        // é—®é¢˜åˆ—è¡¨
        if (data.issues && data.issues.length > 0) {
            html += '<div class="issues-list">';
            data.issues.forEach(issue => {
                html += `<div class="issue-item">âš ï¸ ${issue}</div>`;
            });
            html += '</div>';
        }

        // è­¦å‘Šåˆ—è¡¨
        if (data.warnings && data.warnings.length > 0) {
            html += '<div class="issues-list">';
            data.warnings.forEach(warning => {
                html += `<div class="warning-item">âš ï¸ ${warning}</div>`;
            });
            html += '</div>';
        }

        // è¿æ¥ä¿¡æ¯
        html += `
                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-item">
                        <div class="stat-value">${data.activeConnections || 0}</div>
                        <div class="stat-label">æ´»åŠ¨è¿æ¥</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.maxConnections || 0}</div>
                        <div class="stat-label">æœ€å¤§è¿æ¥</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.idleConnections || 0}</div>
                        <div class="stat-label">ç©ºé—²è¿æ¥</div>
                    </div>
                </div>
            `;

        healthDiv.innerHTML = html;
    }

    // é‡ç½®ç»Ÿè®¡
    async function resetStats() {
        if (!confirm('ç¡®å®šè¦é‡ç½®ç»Ÿè®¡ä¿¡æ¯å—ï¼Ÿ')) {
            return;
        }

        try {
            const response = await fetch('/api/monitor/druid/reset', {
                method: 'POST'
            });
            const result = await response.json();

            if (result.status === 'SUCCESS') {
                alert('ç»Ÿè®¡ä¿¡æ¯å·²é‡ç½®');
                refreshData();
            } else {
                alert('é‡ç½®å¤±è´¥: ' + result.message);
            }
        } catch (error) {
            alert('é‡ç½®å¤±è´¥: ' + error.message);
        }
    }

    // æ£€æŸ¥åŠŸèƒ½
    async function checkCapabilities() {
        try {
            const response = await fetch('/api/monitor/druid/capabilities');
            const data = await response.json();

            const capabilitiesDiv = document.getElementById('capabilities');
            const contentDiv = document.getElementById('capabilitiesContent');

            let html = '';

            if (data.isDruid) {
                html += `<p><strong>æ•°æ®æºç±»å‹:</strong> ${data.dataSourceType}</p>`;
                html += `<p><strong>å¯ç”¨æ–¹æ³•:</strong> ${data.availableMethods ? data.availableMethods.length : 0}/${data.totalMethods}</p>`;
                html += `<p><strong>å¯ç”¨ç‡:</strong> ${data.availablePercentage || 'N/A'}</p>`;

                if (data.availableMethods && data.availableMethods.length > 0) {
                    html += '<h3>å¯ç”¨æ–¹æ³•åˆ—è¡¨:</h3><ul>';
                    data.availableMethods.forEach(method => {
                        html += `<li>${method}</li>`;
                    });
                    html += '</ul>';
                }
            } else {
                html += `<p>å½“å‰æ•°æ®æºä¸æ˜¯ Druid ç±»å‹: ${data.dataSourceType}</p>`;
            }

            contentDiv.innerHTML = html;
            capabilitiesDiv.style.display = 'block';

        } catch (error) {
            console.error('æ£€æŸ¥åŠŸèƒ½å¤±è´¥:', error);
            showError('æ£€æŸ¥åŠŸèƒ½å¤±è´¥');
        }
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
        const poolStatusDiv = document.getElementById('poolStatus');
        poolStatusDiv.innerHTML = `<div class="stat-item"><div class="stat-value status-critical">é”™è¯¯</div><div class="stat-label">${message}</div></div>`;
    }

    // æ¸…ç†å®šæ—¶å™¨
    window.addEventListener('beforeunload', function () {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
</script>
</body>
</html>